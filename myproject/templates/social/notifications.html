{% extends "social/base.html" %}
{% block title %}Notifications{% endblock %}
{% block content %}
<div class="row">
  <div class="col-lg-7 mx-auto">
    <div class="d-flex justify-content-between align-items-center mb-2 gap-2">
      <h5 class="mb-0">Notifications</h5>
      <div class="d-flex gap-2">
        <button id="read-all-drf" class="btn btn-sm btn-outline-secondary">Mark all as read</button>
        <button id="delete-all-drf" class="btn btn-sm btn-outline-danger">Delete all</button>
      </div>
    </div>

    <div id="notif-list" class="list-group">
      {% for n in notifications %}
        <div class="list-group-item d-flex justify-content-between align-items-center {% if not n.is_read %}list-group-item-warning{% endif %}" data-id="{{ n.id }}">
          <div class="me-2">
            {% if n.actor %}
              <strong>{{ n.actor.get_full_name|default:n.actor.email }}</strong>
            {% endif %}
            {{ n.verb }}
            <span class="text-muted small">· {{ n.created_at|date:"M d, Y H:i" }}</span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary view-detail" data-id="{{ n.id }}" data-kind="drf">
              View
            </button>

            <button class="btn btn-sm btn-outline-primary mark-read"
                    data-id="{{ n.id }}"
                    data-kind="drf"
                    {% if n.is_read %}disabled{% endif %}>
              {% if n.is_read %}Read{% else %}Mark read{% endif %}
            </button>

            <button class="btn btn-sm btn-outline-danger delete-item" data-id="{{ n.id }}" data-kind="drf">
              Delete
            </button>
          </div>
        </div>
      {% empty %}
        <div class="alert alert-light border">No notifications.</div>
      {% endfor %}
    </div>

    {% include "social/pagination.html" %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap Modal -->
<div class="modal fade" id="notifDetailModal" tabindex="-1" aria-labelledby="notifDetailLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="notifDetailLabel">Notification Detail</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="notif-detail-body">
        <div class="text-muted small">Loading…</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
/** ---------- CSRF + Fetch Helpers ---------- */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  return null;
}
const CSRF = getCookie('csrftoken');

async function apiFetch(url, {method='GET', data=null, headers={}} = {}) {
  const opts = { method, headers: { 'X-Requested-With': 'XMLHttpRequest', ...headers } };
  if (!['GET','HEAD'].includes(method)) {
    opts.headers['Content-Type'] = 'application/json';
    if (CSRF) opts.headers['X-CSRFToken'] = CSRF;
    if (data) opts.body = JSON.stringify(data);
  }
  const res = await fetch(url, opts);
  let json = null;
  try { json = await res.json(); } catch (_) {}
  return { ok: res.ok, status: res.status, data: json };
}

/** ---------- DOM helpers ---------- */
function markRowAsRead(row) {
  row.classList.remove('list-group-item-warning');
  row.querySelectorAll('.mark-read').forEach(btn => {
    btn.textContent = 'Read';
    btn.disabled = true;
  });
}
function markAllButtonsRead() {
  document.querySelectorAll('#notif-list .list-group-item').forEach(markRowAsRead);
}
function removeRow(row) {
  row?.parentNode?.removeChild(row);
  // Empty state if needed
  if (!document.querySelector('#notif-list .list-group-item')) {
    const empty = document.createElement('div');
    empty.className = 'alert alert-light border';
    empty.textContent = 'No notifications.';
    document.getElementById('notif-list').appendChild(empty);
  }
}
function clearAllRows() {
  document.getElementById('notif-list').innerHTML = '<div class="alert alert-light border">No notifications.</div>';
}

/** ---------- DRF endpoints ---------- */
async function markReadDRF(id, row) {
  const url = `/api/notifications/${id}/`;
  const { ok, data } = await apiFetch(url, { method: 'PATCH', data: { is_read: true } });
  if (ok) markRowAsRead(row);
}

async function viewDetailDRF(id) {
  const url = `/api/notifications/${id}/`;
  return apiFetch(url, { method: 'GET' }); // expects JSON detail
}

async function deleteItemDRF(id) {
  const url = `/api/notifications/${id}/`;
  return apiFetch(url, { method: 'DELETE' });
}

async function deleteAllDRF() {
  // custom action
  const url = `/api/notifications/delete_all/`;
  return apiFetch(url, { method: 'POST', data: {} });
}

async function markAllReadDRF() {
  const url = `/api/notifications/mark_all_read/`;
  return apiFetch(url, { method: 'POST', data: {} });
}

/** ---------- Modal rendering ---------- */
function renderDetailIntoModal(payload) {
  const body = document.getElementById('notif-detail-body');
  if (!payload) {
    body.innerHTML = '<div class="text-danger small">No data.</div>';
    return;
  }
  // The serializer should expose these fields; fall back if missing.
  const actor = payload.actor_name || payload.actor_email || 'Someone';
  const verb = payload.verb || 'did something';
  const created = payload.created_at || '';
  const extra = payload.extra || null;     // optional dict
  const link  = payload.link || payload.url || null; // optional URL to target

  let html = `
    <div class="mb-2"><strong>${actor}</strong> ${verb}</div>
    ${created ? `<div class="text-muted small mb-2">${created}</div>` : ''}
  `;

  if (extra && typeof extra === 'object') {
    html += `<div class="mb-2"><pre class="mb-0" style="white-space:pre-wrap;">${JSON.stringify(extra, null, 2)}</pre></div>`;
  }
  if (link) {
    html += `<a class="btn btn-sm btn-outline-primary" href="${link}">Open related item</a>`;
  }
  body.innerHTML = html;
}

/** ---------- Wire up (event delegation) ---------- */
document.addEventListener('click', async (e) => {
  const row = e.target.closest('.list-group-item');
  // Per-item: Mark read
  if (e.target.closest('.mark-read')) {
    const btn = e.target.closest('.mark-read');
    const id = btn.dataset.id;
    btn.disabled = true;
    try { 
      await markReadDRF(id, row);
    } catch (err) {
      btn.disabled = false;
      console.error(err);
    }
  }

  // Per-item: View detail
  if (e.target.closest('.view-detail')) {
    const btn = e.target.closest('.view-detail');
    const id = btn.dataset.id;
    const detailModal = new bootstrap.Modal(document.getElementById('notifDetailModal'));
    document.getElementById('notif-detail-body').innerHTML = '<div class="text-muted small">Loading…</div>';
    detailModal.show();
    try {
      const { ok, data } = await viewDetailDRF(id);
      if (ok) renderDetailIntoModal(data);
      else document.getElementById('notif-detail-body').innerHTML = '<div class="text-danger small">Failed to load.</div>';
    } catch (err) {
      document.getElementById('notif-detail-body').innerHTML = '<div class="text-danger small">Error occurred.</div>';
    }
  }

  // Per-item: Delete
  if (e.target.closest('.delete-item')) {
    const btn = e.target.closest('.delete-item');
    const id = btn.dataset.id;
    btn.disabled = true;
    try {
      const { ok } = await deleteItemDRF(id);
      if (ok) removeRow(row);
      else btn.disabled = false;
    } catch (err) {
      btn.disabled = false;
      console.error(err);
    }
  }

  // Bulk: Mark all read
  if (e.target.id === 'read-all-drf') {
    e.preventDefault();
    const b = e.target; b.disabled = true;
    try {
      const { ok } = await markAllReadDRF();
      if (ok) markAllButtonsRead();
    } finally { b.disabled = false; }
  }

  // Bulk: Delete all
  if (e.target.id === 'delete-all-drf') {
    e.preventDefault();
    const b = e.target; b.disabled = true;
    try {
      const { ok } = await deleteAllDRF();
      if (ok) clearAllRows();
    } finally { b.disabled = false; }
  }
});
</script>
{% endblock %}
