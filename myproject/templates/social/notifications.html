{% extends "social/base.html" %}
{% load static humanize %}

{% block title %}Notifications{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-7 mx-auto">
    <div class="d-flex justify-content-between align-items-center mb-2 gap-2">
      <h5 class="mb-0">Notifications</h5>
      <div class="d-flex gap-2">
        <button id="read-all-drf" class="btn btn-sm btn-outline-secondary">Mark all as read</button>
        <button id="delete-all-drf" class="btn btn-sm btn-outline-danger">Delete all</button>
      </div>
    </div>

    <div id="notif-list" class="list-group">
      {% for n in notifications %}
        <div class="list-group-item d-flex justify-content-between align-items-center {% if not n.is_read %}list-group-item-warning{% endif %}" data-id="{{ n.id }}">
          <div class="me-2">
            {# ---------- Actor display (full_name -> first/last -> email -> username) ---------- #}
            {% if n.actor %}
              <a class="fw-semibold text-decoration-none" href="{% url 'social:profile-detail' n.actor.id %}">
                {% with pf=n.actor.profile %}
                  {% if pf and pf.full_name %}
                    {{ pf.full_name }}
                  {% elif n.actor.first_name or n.actor.last_name %}
                    {{ n.actor.first_name }}{% if n.actor.last_name %} {{ n.actor.last_name }}{% endif %}
                  {% elif n.actor.email %}
                    {{ n.actor.email }}
                  {% else %}
                    {{ n.actor.username }}
                  {% endif %}
                {% endwith %}
              </a>
            {% else %}
              <strong>Someone</strong>
            {% endif %}

            {# ---------- Text + post link + excerpt (from n.extra) ---------- #}
            {% with ex=n.extra %}
              {% if n.verb == 'commented' %}
                commented on
                {% if ex and ex.post_id %}
                  <a class="text-decoration-none" href="{% url 'social:post-detail' ex.post_id %}">your post</a>
                {% else %}
                  your post
                {% endif %}
                {% if ex and ex.comment_excerpt %}
                  : <span class="text-muted">"{{ ex.comment_excerpt|truncatechars:80 }}"</span>
                {% elif ex and ex.post_excerpt %}
                  : <span class="text-muted">"{{ ex.post_excerpt|truncatechars:80 }}"</span>
                {% endif %}
              {% elif n.verb == 'liked' %}
                liked
                {% if ex and ex.post_id %}
                  <a class="text-decoration-none" href="{% url 'social:post-detail' ex.post_id %}">your post</a>
                {% else %}
                  your post
                {% endif %}
              {% else %}
                {{ n.verb }}
                {% if ex and ex.post_id %}
                  <a class="text-decoration-none" href="{% url 'social:post-detail' ex.post_id %}">your post</a>
                {% endif %}
                {% if ex and ex.post_excerpt %}
                  : <span class="text-muted">"{{ ex.post_excerpt|truncatechars:80 }}"</span>
                {% endif %}
              {% endif %}
            {% endwith %}

            {# ---------- Human time: "x ago" ---------- #}
            <span class="text-muted small">· {{ n.created_at|timesince }} ago</span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary view-detail" data-id="{{ n.id }}">View</button>
            <button class="btn btn-sm btn-outline-danger delete-item" data-id="{{ n.id }}">Delete</button>
          </div>
        </div>
      {% empty %}
        <div class="alert alert-light border">No notifications.</div>
      {% endfor %}
    </div>

    {# Optional pagination include #}
    {% include "social/pagination.html" %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Detail Modal -->
<div class="modal fade" id="notifDetailModal" tabindex="-1" aria-labelledby="notifDetailLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="notifDetailLabel">Notification Detail</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="notif-detail-body">
        <div class="text-muted small">Loading…</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- CSRF helper ---------- */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  return null;
}
const CSRF = getCookie('csrftoken');

/* ---------- Fetch wrapper ---------- */
async function apiFetch(url, {method='GET', data=null, headers={}} = {}) {
  const opts = { method, headers: { 'X-Requested-With': 'XMLHttpRequest', ...headers } };
  if (!['GET','HEAD'].includes(method)) {
    opts.headers['Content-Type'] = 'application/json';
    if (CSRF) opts.headers['X-CSRFToken'] = CSRF;
    if (data) opts.body = JSON.stringify(data);
  }
  const res = await fetch(url, opts);
  let json = null;
  try { json = await res.json(); } catch (_) {}
  return { ok: res.ok, status: res.status, data: json };
}

/* ---------- Small DOM helpers ---------- */
function markRowAsRead(row) {
  row?.classList.remove('list-group-item-warning');
  const badge = document.getElementById('notif-badge');
  if (badge && !badge.classList.contains('d-none')) {
    const cur = parseInt(badge.textContent || '0', 10);
    if (!Number.isNaN(cur) && cur > 0) {
      const next = cur - 1;
      badge.textContent = String(next);
      if (next <= 0) badge.classList.add('d-none');
    }
  }
}
function removeRow(row) {
  row?.parentNode?.removeChild(row);
  if (!document.querySelector('#notif-list .list-group-item')) {
    const empty = document.createElement('div');
    empty.className = 'alert alert-light border';
    empty.textContent = 'No notifications.';
    document.getElementById('notif-list').appendChild(empty);
  }
}
function clearAllRows() {
  document.getElementById('notif-list').innerHTML = '<div class="alert alert-light border">No notifications.</div>';
}

/* ---------- API endpoints ---------- */
async function fetchDetail(id)   { return apiFetch(`/api/notifications/${id}/`, { method: 'GET' }); }
async function patchRead(id)     { return apiFetch(`/api/notifications/${id}/`, { method: 'PATCH', data: { is_read: true } }); }
async function deleteItem(id)    { return apiFetch(`/api/notifications/${id}/`, { method: 'DELETE' }); }
async function markAllRead()     { return apiFetch(`/api/notifications/mark_all_read/`, { method: 'POST', data: {} }); }
async function deleteAll()       { return apiFetch(`/api/notifications/delete_all/`, { method: 'POST', data: {} }); }

/* ---------- Modal rendering (expects serializer extra fields) ---------- */
function esc(text) {
  const div = document.createElement('div');
  div.textContent = text ?? '';
  return div.innerHTML;
}
function renderDetailIntoModal(payload) {
  const body = document.getElementById('notif-detail-body');
  if (!payload) { body.innerHTML = '<div class="text-danger small">No data.</div>'; return; }

  const actorName  = payload.actor_name || payload.actor_email || 'Someone';
  const actorUrl   = payload.actor_profile_url || null;
  const verb       = payload.verb || 'did something';
  const createdH   = payload.created_at_human || '';     // e.g. “3 minutes ago”
  const targetUrl  = payload.target_url || null;         // post link
  const preview    = payload.preview || null;            // comment/post excerpt
  const post       = payload.target_post || null;        // { id,url,text,photo_url,created_at_human,author_* }

  const actorHTML = actorUrl
    ? `<a href="${actorUrl}" class="fw-semibold text-decoration-none">${esc(actorName)}</a>`
    : `<strong>${esc(actorName)}</strong>`;

  let top = `${actorHTML} ${esc(verb)}`;
  if (targetUrl) top += ` <a href="${targetUrl}" class="text-decoration-none">your post</a>`;

  let html = `
    <div class="mb-2">${top}</div>
    ${createdH ? `<div class="text-muted small mb-2">${esc(createdH)} </div>` : ''}

    {% comment %}
     ${preview ? `<div class="mb-3"><span class="text-muted">"${esc(preview)} "</span></div>` : ''}
    {% endcomment %}
  `;

  if (post) {
    html += `
      <div class="card border-0 shadow-sm bg-primary-subtle">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div>
              ${post.author_profile_url
                ? `<a href="${post.author_profile_url}" class="fw-semibold text-decoration-none">${esc(post.author_name || '')}</a>`
                : `<span class="fw-semibold">${esc(post.author_name || '')}</span>`}
              ${post.created_at_human ? `<div class="text-muted small">${esc(post.created_at_human)}</div>` : ''}
            </div>
            ${post.url ? `<a href="${post.url}" class="btn btn-sm btn-outline-primary">Open post</a>` : ''}
          </div>
          ${post.text ? `<p class="mb-2">${esc(post.text)}</p>` : ''}
          ${post.photo_url ? `<img src="${post.photo_url}" alt="Post image" class="img-fluid rounded">` : ''}
        </div>
      </div>
    `;
  }

  body.innerHTML = html;
}

/* ---------- Click handlers ---------- */
document.addEventListener('click', async (e) => {
  const row = e.target.closest('.list-group-item');

  // View detail: open modal + mark as read
  if (e.target.closest('.view-detail')) {
    const id = e.target.closest('.view-detail').dataset.id;
    const modal = new bootstrap.Modal(document.getElementById('notifDetailModal'));
    document.getElementById('notif-detail-body').innerHTML = '<div class="text-muted small ">Loading…</div>';
    modal.show();

    try {
      const { ok, data } = await fetchDetail(id);
      if (ok) renderDetailIntoModal(data);
      else document.getElementById('notif-detail-body').innerHTML = '<div class="text-danger small">Failed to load.</div>';
    } catch (err) {
      document.getElementById('notif-detail-body').innerHTML = '<div class="text-danger small">Error occurred.</div>';
    }

    try {
      const { ok } = await patchRead(id);
      if (ok) markRowAsRead(row);
    } catch (_) {}
  }

  // Delete a single notification
  if (e.target.closest('.delete-item')) {
    const btn = e.target.closest('.delete-item');
    const id = btn.dataset.id;
    btn.disabled = true;
    try {
      const { ok } = await deleteItem(id);
      if (ok) removeRow(row); else btn.disabled = false;
    } catch (err) {
      btn.disabled = false;
      console.error(err);
    }
  }

  // Bulk: mark all as read
  if (e.target.id === 'read-all-drf') {
    e.preventDefault();
    const b = e.target; b.disabled = true;
    try {
      const { ok } = await markAllRead();
      if (ok) document.querySelectorAll('#notif-list .list-group-item').forEach(markRowAsRead);
    } finally { b.disabled = false; }
  }

  // Bulk: delete all
  if (e.target.id === 'delete-all-drf') {
    e.preventDefault();
    const b = e.target; b.disabled = true;
    try {
      const { ok } = await deleteAll();
      if (ok) clearAllRows();
    } finally { b.disabled = false; }
  }
});
</script>
{% endblock %}
