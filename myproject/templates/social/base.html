{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Uni Social{% endblock %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    body { background: #e1e7f3; }
    .card { border: 0; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .avatar { width:44px; height:44px; border-radius:50%; object-fit:cover; }
    .post-photo { max-height: 540px; object-fit: cover; }
    /* Toast sizing */
    .toast { max-width: 360px; }
    @media (max-width: 576px) {
      .toast-container { width: 100%; left: 0; right: 0; }
      .toast { width: 100%; max-width: none; }
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body>
  {% include "social/nav_bar.html" %}

  <main class="container py-4">
    <!-- Toasts (top-right) -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1080;">
      {% if messages %}
        {% for m in messages %}
          <div class="toast fade border-0 shadow-lg mb-2
                      {% if 'success' in m.tags %}text-bg-light
                      {% elif 'error' in m.tags or 'danger' in m.tags %}text-bg-danger
                      {% elif 'warning' in m.tags %}text-bg-warning
                      {% else %}text-bg-info{% endif %}"
               role="alert" aria-live="assertive" aria-atomic="true"
               data-bs-autohide="true" data-bs-delay="3000">
            <div class="toast-header border-0 bg-transparent">
              <strong class="me-auto">UniSocial</strong>
              <span class="badge text-uppercase ms-2
                           {% if 'success' in m.tags %}text-bg-success
                           {% elif 'error' in m.tags or 'danger' in m.tags %}text-bg-danger
                           {% elif 'warning' in m.tags %}text-bg-warning
                           {% else %}text-bg-info{% endif %}">
                {% if 'success' in m.tags %}Success
                {% elif 'error' in m.tags or 'danger' in m.tags %}Error
                {% elif 'warning' in m.tags %}Warning
                {% else %}Info{% endif %}
              </span>
              <small class="ms-2 opacity-75">just now</small>
              <button type="button"
                      class="btn-close ms-2 {% if 'warning' in m.tags %}{% else %}btn-close-dark{% endif %}"
                      data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">{{ m }}</div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    {% block content %}{% endblock %}
  </main>

  <!-- Bootstrap Bundle (must load before scripts that use `bootstrap`) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Shared helpers (CSRF, fetch, notif badge, global like/save handlers, delete modal) -->
  <script>
  // --- CSRF + fetch helpers ---
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i=0; i<cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const CSRF_TOKEN = getCookie('csrftoken');

  async function apiFetch(url, {method='GET', data=null, headers={}} = {}) {
    const opts = { method, headers: { 'X-Requested-With': 'XMLHttpRequest', ...headers } };
    if (!['GET','HEAD'].includes(method)) {
      if (headers['Content-Type'] !== 'application/x-www-form-urlencoded') {
        opts.headers['Content-Type'] = 'application/json';
        if (data) opts.body = JSON.stringify(data);
      } else {
        // when explicitly using x-www-form-urlencoded
        opts.body = new URLSearchParams(data || {});
      }
      if (CSRF_TOKEN) opts.headers['X-CSRFToken'] = CSRF_TOKEN;
    }
    const res = await fetch(url, opts);
    let json = null; try { json = await res.json(); } catch(_){}
    return { ok: res.ok, status: res.status, data: json };
  }

  // --- Toasts (initialize after bootstrap is available) ---
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('.toast').forEach(function (el) {
      new bootstrap.Toast(el).show();
    });
  });

  // --- Notification badge helpers (single implementation) ---
  function getBadgeEl(){ return document.getElementById('notif-badge'); }
  function setBadgeCount(n){
    const el = getBadgeEl(); if(!el) return;
    if(n > 0){
      el.textContent = n > 99 ? '99+' : String(n);
      el.classList.remove('d-none');
    }else{
      el.textContent = '';
      el.classList.add('d-none');
    }
  }
  async function refreshNotifBadge(){
    try{
      const res = await fetch('/api/notifications/unread_count/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin',
        cache: 'no-store'
      });
      if(!res.ok) return;
      const { count } = await res.json();
      setBadgeCount(count || 0);
    }catch(_){}
  }
  window.refreshNotifBadge = refreshNotifBadge;

  document.addEventListener('DOMContentLoaded', () => {
    refreshNotifBadge();
    // setInterval(refreshNotifBadge, 30000); // optional polling
  });

  // --- Global like/save (event delegation) ---
  document.addEventListener('click', async (e) => {
    // LIKE
    const likeBtn = e.target.closest('.like-btn');
    if (likeBtn) {
      const postId = likeBtn.dataset.id;
      likeBtn.disabled = true;
      try {
        const { ok, data } = await apiFetch(`/posts/${postId}/like/`, { method: 'POST' });
        if (ok && data) {
          // count
          const countEl = document.getElementById(`like-count-${postId}`);
          if (countEl && typeof data.likes_count !== 'undefined') countEl.textContent = data.likes_count;

          // icon/state
          const i = likeBtn.querySelector('i');
          if (data.liked) {
            likeBtn.classList.remove('btn-outline-primary');
            likeBtn.classList.add('btn-primary');
            if (i) i.className = 'fa-solid fa-thumbs-up me-1';
          } else {
            likeBtn.classList.add('btn-outline-primary');
            likeBtn.classList.remove('btn-primary');
            if (i) i.className = 'fa-regular fa-thumbs-up me-1';
          }
        }
      } finally {
        likeBtn.disabled = false;
      }
      return;
    }

    // SAVE (if you add a .save-btn in your card)
    const saveBtn = e.target.closest('.save-btn');
    if (saveBtn) {
      const postId = saveBtn.dataset.id;
      saveBtn.disabled = true;
      try {
        const { ok, data } = await apiFetch(`/posts/${postId}/save/`, { method: 'POST' });
        if (ok && data) {
          const countEl = document.getElementById(`save-count-${postId}`);
          if (countEl && typeof data.saves_count !== 'undefined') countEl.textContent = data.saves_count;

          const i = saveBtn.querySelector('i');
          if (data.saved) {
            saveBtn.classList.remove('btn-outline-secondary');
            saveBtn.classList.add('btn-secondary');
            if (i) i.className = 'fa-solid fa-bookmark me-1';
          } else {
            saveBtn.classList.add('btn-outline-secondary');
            saveBtn.classList.remove('btn-secondary');
            if (i) i.className = 'fa-regular fa-bookmark me-1';
          }
        }
      } finally {
        saveBtn.disabled = false;
      }
      return;
    }
  });

  // --- Delete post modal (AJAX) ---
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.delete-post-form').forEach(function (form) {
      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const postId = form.dataset.postId;
        const url = form.getAttribute('action');

        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRFToken': CSRF_TOKEN,
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          if (res.status === 204) {
            // Close modal
            const modalEl = form.closest('.modal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();

            // Remove the card
            const card = document.getElementById(`post-card-${postId}`);
            if (card) card.remove();
          } else if (res.status === 403) {
            alert('You can delete only your own post.');
          } else {
            window.location.reload();
          }
        } catch (err) {
          console.error(err);
          window.location.reload();
        }
      });
    });
  });
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
